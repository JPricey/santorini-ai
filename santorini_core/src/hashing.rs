use crate::board::{BoardState, FullGameState};

pub(crate) type HashType = u64;

pub(crate) const ZORBRIST_HEIGHT_RANDOMS: [[HashType; 32]; 4] = [
    [
        6085914211561695364,
        2559176765352864341,
        4969966255964861466,
        6373954715133973205,
        7939215197696701022,
        15030897891908622727,
        5164373773224280720,
        1206674465991439158,
        2021820794730007632,
        11142437487527372565,
        9157723483968781352,
        16640843310384849689,
        14886492272576335710,
        15419418561768868542,
        11929433446316010316,
        15183038824932755614,
        16003660769376671114,
        17033284363515533578,
        6384192464977723482,
        7049082735589091383,
        11866555962164820186,
        8664094256728712211,
        12773694605789239011,
        3811591479797082568,
        7648447381600870155,
        6918852752988730053,
        6417424841170500213,
        10169750470022367523,
        9562339634235000932,
        9227593363191124188,
        4229242712288491201,
        12408669026567757793,
    ],
    [
        10845838326289089393,
        12528748008327828270,
        12650721979858603796,
        207235363130459639,
        3152506069642728711,
        7042286475948849097,
        8792397865475664770,
        5696110434269215996,
        1034687493973921472,
        5215072699829149867,
        5643122909305761839,
        14440658118690594726,
        6879268492360217172,
        9482296261259561813,
        2181048330318694467,
        1222787733934773570,
        11472512812938580129,
        12326640246447270534,
        8234403339025655175,
        9305981233052897236,
        14481068344719228925,
        6401309130249156212,
        11381195772666467036,
        13878767474739913204,
        16004634543482774996,
        17057141100631356231,
        18188329244014016356,
        930332167007575581,
        6765079352203735112,
        11283287195944874565,
        7266004470073079801,
        9212369173188373957,
    ],
    [
        11037818713410194038,
        2766077926065708132,
        12638745630785407981,
        17178430814554360448,
        4894219400312719315,
        7930043947206633252,
        6577607308949011432,
        14773582357679275893,
        8781707415105200391,
        11822830757085466705,
        9496066350304576591,
        6930674081752768072,
        9342310371305877879,
        8059136237779086144,
        5370013345671370802,
        17965550859174720364,
        14707403948613431100,
        268590105227186941,
        3853589348885111497,
        15262653693075059962,
        5536142084887375887,
        5428495478568098237,
        3707696933384724543,
        17298507344566248426,
        1304524074563025288,
        4102005249892743235,
        6132886849740870080,
        18304477626771338651,
        11100928551694959985,
        4299872677305805358,
        766640855834533778,
        16575443906418339707,
    ],
    [
        1801413681039076785,
        6236525059491531141,
        10006654378670305675,
        4982823849972469662,
        4756827508497396150,
        82900201855946671,
        4132242312669852576,
        4807771365440938765,
        13606994698613701070,
        16582979679575722080,
        17738304865545207290,
        9108378048755361536,
        13795491625918035070,
        2167747957671454416,
        12028225902715885342,
        14301483132389739617,
        905677559785213555,
        15694641688659696732,
        12883694115655078377,
        10560980095330308581,
        18100842816820156989,
        1565449148107569693,
        10491003788924350399,
        10585745917108258764,
        4394249211425412732,
        5986101776158064212,
        18430195025896735505,
        5714269737705293446,
        174514554563428257,
        13976444563274418940,
        8286271432554716621,
        538863521032612266,
    ],
];

pub(crate) const ZORBRIST_WORKER_RANDOMS: [[HashType; 32]; 2] = [
    [
        3908243075560612309,
        16133310227149639150,
        15929204631964360437,
        13798489603884215802,
        1629468867665759155,
        17172880871914108077,
        3167790182475746994,
        1388374295765046409,
        4567347917221141671,
        4200335496799577078,
        12389356693751020570,
        16401812815404159417,
        17030382075294691895,
        10612130261917004716,
        11299792093244266352,
        5762488881208949690,
        18360755394403931865,
        5536767669859725629,
        8214592334964570968,
        17541844378532013094,
        11946181092913687438,
        937954302092906443,
        5551617975482952277,
        4662419473574144065,
        17648652966936074492,
        8104204093040922505,
        11936484278449121566,
        11043279896356214505,
        7209514472110411588,
        7985611839697645306,
        16358358616107609990,
        1280276269572204154,
    ],
    [
        15376829454398655461,
        10282406571724656171,
        17999599333299964789,
        8433035666586187342,
        7115488774512720780,
        6111565797413373858,
        13692470463967076262,
        4452682995984829123,
        5279672177545701719,
        3007187146029587934,
        4579905507167358862,
        17793196417677874461,
        18059245396150201852,
        839397302864197937,
        14120545697936572878,
        9336205247937267464,
        4652219809431570880,
        11424375350977264962,
        13977875015275851254,
        9650415631806011116,
        4046432993936460288,
        4413830273965177355,
        2537485315430783486,
        18103492717566344094,
        15348044731700097593,
        3487016568778373111,
        16066654070843266176,
        5330181710433151248,
        10367026488964142164,
        17030136284156625298,
        1475272206203976963,
        8060072807475057514,
    ],
];

pub(crate) const ZOBRIST_DATA_RANDOMS: [[HashType; 32]; 2] = [
    [
        11535555303080891210,
        4669952551950478030,
        2909756560645161515,
        14442889577486767651,
        382271170611528812,
        673502173508263488,
        10045958038619179151,
        5059215803169883173,
        438810694811119342,
        15337784731769550510,
        1027010761767458265,
        15265049647436932760,
        18341492111471390920,
        6568039934546562577,
        4727295990874870453,
        11771655525826657454,
        1595898416828270652,
        15187726227090546729,
        8199589321097021111,
        12073772865989227145,
        3915877750251670118,
        14709983702135757182,
        4839745141710326999,
        228479744281837182,
        12847135176371387615,
        10856913653600485656,
        14940603667874447291,
        4795841507032307887,
        6109761788495461891,
        14636897886471331920,
        3842038182171460361,
        8212832692724860001,
    ],
    [
        14015453613755278818,
        93645383156650241,
        7990265418826836360,
        15999036989307801311,
        13125386004937513303,
        4779401101910904129,
        3784632657601320136,
        9978502837588503385,
        14790527697792688882,
        1539187596334261655,
        17712101276042796156,
        8464694055374109841,
        5928859437294908917,
        959229765248386330,
        13397818890879494915,
        12211604811679681738,
        14426768025980351047,
        421671732910787103,
        15309741157062662735,
        5775561614183311601,
        17823597644182357004,
        16887140460093539765,
        9489676493311040635,
        9615741034316247462,
        13879574270920929749,
        2281798212792925758,
        11884767725286388123,
        7953593205986650033,
        1975528747965727255,
        14931189485164055192,
        2117497922435648823,
        15868575883743614813,
    ],
];

pub(crate) const ZORBRIST_PLAYER_TWO: HashType = 9379755890162401779;

pub(crate) const ZORBRIST_ACTIVE_PLAYER: [HashType; 2] = [0, ZORBRIST_PLAYER_TWO];

pub(crate) fn compute_hash_from_scratch(state: &FullGameState) -> HashType {
    compute_hash_from_scratch_for_board(&state.board, state.base_hash())
}

pub(crate) fn compute_hash_from_scratch_for_board(
    board: &BoardState,
    base_hash: HashType,
) -> HashType {
    let mut result = base_hash;

    for h in 0..4 {
        let mut hm = board.height_map[h].0;
        while hm != 0 {
            let lsb = hm.trailing_zeros();
            hm &= hm - 1;
            result ^= ZORBRIST_HEIGHT_RANDOMS[h][lsb as usize];
        }
    }

    for w in 0..2 {
        for square in board.workers[w] {
            result ^= ZORBRIST_WORKER_RANDOMS[w][square as usize];
        }
    }

    for w in 0..2 {
        let mut bb = board.god_data[w];
        while bb > 0 {
            let lsb = bb.trailing_zeros();
            bb &= bb - 1;
            result ^= ZOBRIST_DATA_RANDOMS[w][lsb as usize];
        }
    }

    result ^= ZORBRIST_ACTIVE_PLAYER[board.current_player as usize];

    result
}
